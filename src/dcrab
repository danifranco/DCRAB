#!/bin/bash


# Check if binary path is defined
if [ -z "$DCRAB_BIN" ]; then
    echo "ERROR: DCRAB_BIN undefined"
    exit
fi

# Configuration functions
source $DCRAB_BIN/scripts/dcrab_config.sh

# Check arguments
case "$1" in
	start)
		echo "--- Start DCRAB output (start fase) ---"

		# Check which scheduler use the system
		dcrab_check_scheduler

		dcrab_init_variables

 		# Move to working directory
                cd $DCRAB_WORKDIR
	
		# Create report and log directories 
		mkdir -p $DCRAB_REPORT_DIR/log

                # Initialize log report of the main node
		echo "--- DCRAB main-node: `hostname` log ---" >> $DCRAB_LOG_DIR/dcrab.log
		
        	# Initialize dcrab report
		dcrab_start_report >> $DCRAB_LOG_DIR/dcrab.log 2>&1 

		export DCRAB_START_TIMESTAMP=`date +"%s"`

		# Launch processes in each node to collect data
		dcrab_start_data_collection  >> $DCRAB_LOG_DIR/dcrab.log 2>&1
	
		echo "--- End DCRAB output (start fase)---"
            	;;
	finish)
		echo "--- Start DCRAB output (finish fase) ---"
		
		# Check which scheduler use the system
                dcrab_check_scheduler

		export DCRAB_REPORT_DIR=dcrab_report_$DCRAB_JOB_ID
		export DCRAB_LOG_DIR=$DCRAB_REPORT_DIR/log

   		# Move to working directory
                cd $DCRAB_WORKDIR

		# Finalize DCRAB
		dcrab_finalize  >> $DCRAB_LOG_DIR/dcrab.log 2>&1

		echo "--- End DCRAB output (finish fase) ---"
            	;;
        *)
		echo "DCRAB report help"
		echo "Developed by DIPC Fundation, CC-staff"
		echo ""
                echo $"Usage: $0 {start|finish}"
		echo ""
		echo "Summary:"
		echo "    * start 		| starts DCRAB report"
		echo "    * finish 		| finalize data collection and DCRAB processes"
		echo ""
            	exit 1
esac

